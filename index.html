<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>お問い合わせフォーム</title>
    <link rel="stylesheet" href="reboot.css">
    <link rel="stylesheet" href="Mystyle.css">
</head>

<body>
    <header>
        <div id="header">
            <p class="title">Form</p>
        </div>
    </header>

    <main>
        <div id="form_wrapper" class="form_wrapper">
            <div class="form_description">
                <h1 class="form_title">お問い合わせフォーム</h1>
                <div class="description">
                    <p>※個人情報の取り扱いについて</p>
                    <p>ご入力いただきましたお客様の個人情報は、本お問い合わせに関する回答以外の目的には利用いたしません。<br></p>
                    <p><span class="required">(必須)</span>は必須入力項目です。</p>
                </div>
            </div>

            <div id="form_content_wrapper" class="form_content_wrapper">

                <!-- メールアドレス -->
                <div class="form_content">
                    <h2>メールアドレス<span class="required">(必須)</span></h2>
                    <div class="mail">
                        <label>
                            <p>ご返信先メールアドレス</p>
                            <input type="text" id="mail" name="mail" autocomplete="off">
                        </label>
                    </div>
                    <div class="mail_sub">
                        <label>
                            <p>確認のため、もう一度入力してください。</p>
                            <input type="text" id="r_mail" name="r_mail" autocomplete="off">
                        </label>
                    </div>
                </div>

                <!-- 名前 -->
                <div class="form_content">
                    <label>
                        <h2>氏名<span class="required">(必須)</span></h2>
                        <input type="text" id="name" name="name" autocomplete="off">
                    </label>

                </div>

                <!--年齢-->
                <div class="form_content">
                    <label>
                        <h2>年齢</h2>
                        <select name="age" id="age_selector">

                        </select>
                    </label>
                </div>

                <!-- 電話番号 -->
                <div class="form_content">
                    <label>
                        <h2>ご連絡先電話番号</h2>
                        <input type="tel" id="phone_number" name="phone_number" value="" autocomplete="off" />
                    </label>
                </div>

                <!-- 問い合わせ種類 -->
                <div class="form_content">
                    <label>
                        <h2>お問い合わせの種類 <span class="required">(必須)</span></h2>
                        <select id="type" name="types" class="types">
                            <option value="">選択してください</option>
                            <option value="料金に関するお問い合わせ">料金に関するお問い合わせ</option>
                            <option value="サービスに関するお問い合わせ">サービスに関するお問い合わせ</option>
                            <option value="ご意見、ご要望">ご意見、ご要望</option>
                            <option value="その他お問い合わせ">その他お問い合わせ</option>
                        </select>
                    </label>
                </div>

                <!-- お問い合わせ内容 -->
                <div class="form_content">
                    <div class="contents">
                        <label>
                            <h2>お問い合わせの内容<span class="required">(必須)</span></h2>
                            <p>200文字まで</p>
                            <textarea id="content" name="content" maxlength="200" class="content"></textarea>
                        </label>
                    </div>
                </div>

                <button type="button" class="but" onClick="confirm();">確認</button>
            </div>

        </div>
    </main>

    <footer></footer>

    <script>

        // 年齢セレクタの展開
        const age = () => {
            const ageSelector = document.getElementById("age_selector");

            const preAge = document.createElement("option");
            preAge.appendChild(document.createTextNode("選択してください"));
            preAge.setAttribute("value", "");

            ageSelector.appendChild(preAge);

            const minAge = 6;
            const maxAge = 100;

            for (let _age = minAge; _age <= maxAge; _age++) {
                const specAge = document.createElement("option");
                specAge.setAttribute("value", _age);
                specAge.appendChild(document.createTextNode(_age));

                ageSelector.appendChild(specAge);
            }
        }

        document.body.onload = age;

        // 以前のinerHTMLを保持
        let prev = ""
        // 入力値を保持
        let contents = {};
        // form_wrapper エレメント
        let formWrapperElement = document.getElementById("form_wrapper");
        // バックエンドからのレスポンス
        let response = {};

        const thanks = () => {
            let thanksPage = '<h1 class="form_title">完了</h1>'
            thanksPage += '<p>サーバへ送信が完了しました。後ほどご連絡いたします。</p>';
            formWrapperElement.innerHTML = thanksPage;
        }

        const error = () => {
            let errorPage = '<h1 class="form_title">エラー</h1>'

            if (response.database.error === "validation error") {
                errorPage += '<div class=form_content>';
                errorPage += '<p>それぞれの欄を再度ご確認ください。</p>';
                errorPage += '</div>'
                errorPage += '<button type="button" class="but" onClick="cancel();">戻る</button>';
            } else {
                errorPage += '<p>サーバへの送信時にエラーが発生しました。後ほどお試しください。</p>';
            }

            formWrapperElement.innerHTML = errorPage;
        }

        const submit = async () => {
            try {
                const res = await fetch("submit.php", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json;charset=utf-8"
                    },
                    mode: "same-origin",
                    body: JSON.stringify(contents)
                });

                if (!res.ok) throw new Error("サーバ側のエラーにより、サーバへ送信できませんでした。");

                response = await res.json();

                if (response.database.successful) {
                    thanks();
                } else {
                    error();
                }

            } catch (error) {
                alert(error);
            }
        }

        const cancel = () => {
            formWrapperElement.innerHTML = prev;
        }

        const confirm = () => {
            const ageSelector = document.getElementById('age_selector');
            const typeSelector = document.getElementById('type');

            contents = {
                mail: document.getElementById('mail').value,
                reMail: document.getElementById('r_mail').value,
                name: document.getElementById('name').value,
                age: ageSelector.options[ageSelector.selectedIndex].value,
                phoneNumber: document.getElementById('phone_number').value,
                type: typeSelector.options[typeSelector.selectedIndex].value,
                content: document.getElementById('content').value
            };

            prev = formWrapperElement.innerHTML;

            let page = '';
            page += '<h1 class="form_title">確認</h1>';
            page += '<div class=form_content>';
            page += '<p>以下の内容で送信します。</p>';
            page += '<h2 class=form_content>メールアドレス</h2>'
            page += `<p>${contents.mail}</p>`;
            page += '<h2 class=form_content>お名前</h2>';
            page += `<p>${contents.name}</p>`;
            page += '<h2 class=form_content>ご年齢</h2>';
            page += `<p>${contents.age}</p>`;
            page += '<h2 class=form_content>電話番号</h2>';
            page += `<p>${contents.phoneNumber}</p>`;
            page += '<h2 class=form_content>お問い合わせの種類</h2>';
            page += `<p>${contents.type}</p>`;
            page += '<h2 class=form_content>お問い合わせの内容</h2>';
            page += `<p>${contents.content}</p>`;
            page += '</div>';
            page += '<button type="button" class="but" onClick="cancel();">キャンセル</button>';
            page += '<button type="button" class="but" onClick="submit();">送信</button>';

            formWrapperElement.innerHTML = page;
        }
    </script>
</body>

</html>
